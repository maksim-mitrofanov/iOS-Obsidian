
### Copy on механизмы
механизмы копирования ValueType объектов

#### Зачем нужны?
В Swift объекты типа ValueType передаются через копии, а не по ссылке.
Однако, постоянное копирование объектов может сильно нагружать память.
Для оптимизации памяти, ValueType объекты копируются не сразу же, а в определённый момент времени.

Механизмы copy on - как раз определяют, когда нужно создать копию.

Глобально, механизмы copy on можно поделить на три категории:
- Копирование при изменении (on Write, on Mutate, on Assign)
- Копирование при передаче (on Capture, on Move)
- Копирование доступе (on Access, on Apply)

#### Категория 1: Копирование при изменении.
Эти механизмы копируют данные лишь в момент их изменения. При присвоении переменная просто указывает на тот же объект, и только при попытке изменить одну из переменных создается отдельная копия. Такой подход снижает количество ненужных копирований и экономит ресурсы.

##### Copy on Write (CoW):
Используется для коллекций, массивов, строк, словарей и т.д.
Копирование коллекции происходит только в момент записи в переменную с указателем на массив.

```
var array1 = [1, 2, 3]
var array2 = array1
	присваиваем указатель на array1.

array2.append(4)
	копируем array1 в памяти, добавляем 4 в конец.

print(array1)
	[1, 2, 3]
print(array2) 
	[1, 2, 3, 4]
```
---
##### Copy on Mutate: 
Используется для структур с вложенными переменными. 
Копия структуры создаётся только в момент изменения вложенной переменной.

```
struct Container {
    var array = [1, 2, 3]
}

var container1 = Container()
var container2 = container1
	присваиваем указатель на container1.

container2.array.append(4)
	копируем container1 в памяти, меняем вложенную переменную array.
	
print(container1.array)
	[1, 2, 3]
print(container2.array)
	[1, 2, 3, 4]

```
---
##### Copy on Assign:



С этим механизмом связано непредвиденное поведение, когда array ведёт себя как reference type. Если в примере выше добавить 4 в array1, то array2 тоже изменится. Подробнее можно прочитать в [[Поведение коллекций как reference type]].